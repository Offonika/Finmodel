# aggregator.py

import pandas as pd
import xlwings as xw
from collections import defaultdict
import logging
from datetime import datetime
import os

from scripts.style_utils import format_table

BASE_DIR   = os.path.dirname(os.path.abspath(__file__))
EXCEL_PATH = os.path.join(BASE_DIR, 'excel', 'Finmodel.xlsm')
SHEET_NAME = '–ù–∞—á–∏—Å–ª–µ–Ω–∏—è–£—Å–ª—É–≥–û–∑–æ–Ω'

def get_workbook():
    try:
        wb = xw.Book.caller()
        return wb, wb.app, False
    except Exception:
        app = xw.App(visible=False, add_book=False)
        wb  = app.books.open(EXCEL_PATH)
        return wb, app, True

def write_to_excel(df: pd.DataFrame):
    wb, app, created = get_workbook()
    try:
        if SHEET_NAME not in [s.name for s in wb.sheets]:
            wb.sheets.add(SHEET_NAME)
        sht = wb.sheets[SHEET_NAME]
        sht.clear_contents()
        sht.range("A1").value = df.columns.tolist()
        sht.range("A2").value = df.values.tolist()

        # --- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏ —à–∞–ø–∫–∏ ---
        last_row = df.shape[0] + 1  # +1 –¥–ª—è —à–∞–ø–∫–∏
        last_col = df.shape[1]
        table_range = sht.range((1, 1), (last_row, last_col))
        format_table(sht, table_range, "ServiceChargesTable")
        sht.api.Application.ActiveWindow.SplitRow = 1
        sht.api.Application.ActiveWindow.FreezePanes = True

        # --- –¶–≤–µ—Ç —è—Ä–ª—ã–∫–∞ #00FFC0 (–±–∏—Ä—é–∑–∞ –≤ BGR) ---
        try:
            sht.api.Tab.Color = 0xC0FF00
            print("‚Üí –¶–≤–µ—Ç —è—Ä–ª—ã–∫–∞ #00FFC0 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç —è—Ä–ª—ã–∫–∞: {e}")

        # --- –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ª–∏—Å—Ç –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 12 ---
        try:
            if sht.index != 12:
                sht.api.Move(Before=sht.book.sheets[11].api)
                print("‚Üí –õ–∏—Å—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω –Ω–∞ –ø–æ–∑–∏—Ü–∏—é 12")
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ª–∏—Å—Ç: {e}")

        wb.save()
    finally:
        if created:
            wb.close()
            app.quit()

def setup_logger(log_name='aggregator'):
    log_dir = os.path.dirname(os.path.abspath(__file__))
    log_file = os.path.join(log_dir, f"{log_name}_{datetime.now():%Y%m%d}.log")
    logger = logging.getLogger(log_name)
    logger.setLevel(logging.INFO)
    fh = logging.FileHandler(log_file, encoding="utf-8")
    fh.setFormatter(logging.Formatter('%(asctime)s %(levelname)s: %(message)s'))
    if not logger.handlers:
        logger.addHandler(fh)
    return logger

HEADER = [
    '–ú–µ—Å—è—Ü','–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è','SKU','–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∑–≤–∞–Ω–∏–µ','–ü—Ä–æ–¥–∞–Ω–æ–®—Ç','–í—ã—Ä—É—á–∫–∞–ë–µ–∑–°–∫–∏–¥–æ–∫','–ö–æ–º–∏—Å—Å–∏—è',
    '–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ/—É—Ç–∏–ª–∏–∑–∞—Ü–∏—é –≤–æ–∑–≤—Ä–∞—Ç–æ–≤','–û–ø–ª–∞—Ç–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞','–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞','–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è',
    '–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å','–ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è','–û–±—Ä–∞—Ç–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å','–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞','–õ–æ–≥–∏—Å—Ç–∏–∫–∞',
    '–û–±—Ä–∞—Ç–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞','–ò—Ç–æ–≥–õ–æ–≥–∏—Å—Ç–∏–∫–∞','–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –≥–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç','–ó–∞—Ç—Ä–∞—Ç—ã–ù–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ',
    '–î—Ä—É–≥–∏–µ–£—Å–ª—É–≥–∏','–£—Å–ª—É–≥–∏–ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤','–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞','–ë–∞–ª–ª—ã –∑–∞ –æ—Ç–∑—ã–≤—ã','–í—ã–≤–æ–¥ –≤ —Ç–æ–ø','–ü–æ–¥–ø–∏—Å–∫–∞ Premium',
    '–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –°–¶/–ü–í–ó','–£—Å–ª—É–≥–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã',
    '–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞: –ø–æ–∑–¥–Ω—è—è –æ—Ç–≥—Ä—É–∑–∫–∞',
    '–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞: –ø–æ–∑–¥–Ω—è—è –æ—Ç–≥—Ä—É–∑–∫–∞ - –æ—Ç–º–µ–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è',
    '–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞: –í—ã –Ω–µ –∑–∞–±—Ä–∞–ª–∏ –≤ —Å—Ä–æ–∫',
    '–£—Å–ª—É–≥–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ',
    '–£—Å–ª—É–≥–∏ FBO',
    '–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏',
    '–ü—Ä–∏–±—ã–ª—å'
]

def get(row, name):
    try:
        return float(row.get(name, 0) or 0)
    except Exception:
        return 0

def aggregate_data(df: pd.DataFrame) -> pd.DataFrame:
    logger = setup_logger('aggregator')
    logger.info('–°—Ç–∞—Ä—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö')
    df = df.copy()
    df['–ú–µ—Å—è—Ü'] = pd.to_datetime(df['–î–∞—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è'], errors='coerce').dt.to_period('M').astype(str)
    df['–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'] = df['organization'] if 'organization' in df.columns else ''

    # --- –ú–∞–ø–ø–∏–Ω–≥ –¥–ª—è –Ω–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π ---
    fbo_types = [
        "–î–æ—Å—Ç–∞–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥ Ozon (–∫—Ä–æ—Å—Å-–¥–æ–∫–∏–Ω–≥)",
        "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–∞ –≤ —Å–æ—Å—Ç–∞–≤–µ –≥—Ä—É–∑–æ–º–µ—Å—Ç–∞ –Ω–∞ FBO",
        "–£—Å–ª—É–≥–∞ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –º–µ—Å—Ç–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏ —Å –Ω–µ–ø–æ–ª–Ω—ã–º —Å–æ—Å—Ç–∞–≤–æ–º",
        "–£—Å–ª—É–≥–∞ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –º–µ—Å—Ç–∞ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞ –¥–ª—è –ø–æ—Å—Ç–∞–≤–∫–∏ —Å –Ω–µ–ø–æ–ª–Ω—ã–º —Å–æ—Å—Ç–∞–≤–æ–º –≤ —Å–æ—Å—Ç–∞–≤–µ –ì–ú",
        "–£—Å–ª—É–≥–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –∏–∑–ª–∏—à–∫–æ–≤",
        "–£—Å–ª—É–≥–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –∏–∑–ª–∏—à–∫–æ–≤ –≤ —Å–æ—Å—Ç–∞–≤–µ –ì–ú",
        "–£—Å–ª—É–≥–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ"
    ]
    partner_types = [
        "–ó–≤—ë–∑–¥–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã",
        "–£—Å–ª—É–≥–∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏",
        "–£–ø–∞–∫–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º–∏"
    ]
    promo_types = [
        "–í—ã–≤–æ–¥ –≤ —Ç–æ–ø",
        "–ü–æ–¥–ø–∏—Å–∫–∞ Premium",
        "–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞",
        "–ë–∞–ª–ª—ã –∑–∞ –æ—Ç–∑—ã–≤—ã",
        "–ë–æ–Ω—É—Å—ã –ø—Ä–æ–¥–∞–≤—Ü–∞",
        "–ë–æ–Ω—É—Å—ã –ø—Ä–æ–¥–∞–≤—Ü–∞ - —Ä–∞—Å—Å—ã–ª–∫–∞",
        "–ü–æ–¥–ø–∏—Å–∫–∞ Premium Plus",
        "–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –≤ –ø–æ–∏—Å–∫–µ",
        "–¢—Ä–∞—Ñ–∞—Ä–µ—Ç—ã",
        "–ê–±–æ–Ω–µ–Ω—Ç—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é —Ç–æ–≤–∞—Ä–æ–≤"
    ]
    other_services_types = [
        "–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –°–¶/–ü–í–ó",
        "–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –≥–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç",
        "–£—Å–ª—É–≥–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã",
        "–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä. –æ—à–∏–±–æ–∫: –æ—Ç–º–µ–Ω–∞",
        "–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä. –æ—à–∏–±–æ–∫: –ø–æ–∑–¥–Ω—è—è –æ—Ç–≥—Ä—É–∑–∫–∞",
        "–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è",
        "–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞: –í—ã –Ω–µ –∑–∞–±—Ä–∞–ª–∏ –≤ —Å—Ä–æ–∫",
        "–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞: –ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –∏–∑-–∑–∞ —É–ø–∞–∫–æ–≤–∫–∏",
        "–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞: –ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ, –±—ã–ª–∏ —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è",
        "–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞: –ü—Ä–æ—á–µ–µ"
    ]
    compensation_types = [
        "–î–µ–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç–æ–∫",
        "–ü–æ—Ç–µ—Ä—è –ø–æ –≤–∏–Ω–µ Ozon –≤ –ª–æ–≥–∏—Å—Ç–∏–∫–µ",
        "–ü–æ—Ç–µ—Ä—è –ø–æ –≤–∏–Ω–µ Ozon –Ω–∞ —Å–∫–ª–∞–¥–µ",
        "–ë—Ä–∞–∫ –ø–æ –≤–∏–Ω–µ Ozon –Ω–∞ —Å–∫–ª–∞–¥–µ"
    ]

    sales_types = {
        "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é": "sale",
        "–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞, –æ—Ç–º–µ–Ω—ã, –Ω–µ–≤—ã–∫—É–ø–∞ –æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è": "return"
    }
    revenue_types = [
        "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é",
        "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é ‚Äî –æ—Ç–º–µ–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è",
        "–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞, –æ—Ç–º–µ–Ω—ã, –Ω–µ–≤—ã–∫—É–ø–∞ –æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è"
    ]

    groups = defaultdict(lambda: defaultdict(float))
    logger.info(f'–°—Ç—Ä–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {len(df)}')

    for idx, row in df.iterrows():
        if idx % 10000 == 0 and idx > 0:
            logger.info(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—Ç—Ä–æ–∫: {idx}")
        key = (
            row.get('–ú–µ—Å—è—Ü', ''),
            row.get('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', ''),
            str(row.get('SKU', '')).strip() or '',
            str(row.get('–ê—Ä—Ç–∏–∫—É–ª', '')).strip() or '',
            '' if (pd.isna(row.get('SKU')) and pd.isna(row.get('–ê—Ä—Ç–∏–∫—É–ª'))) else str(row.get('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —É—Å–ª—É–≥–∏', '')).strip()
        )

        accr_type = str(row.get('–¢–∏–ø –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è', '')).strip()

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂ –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
        if accr_type in sales_types:
            t = sales_types[accr_type]
            groups[key][f'qty_{t}'] += float(row.get('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', 0) or 0)
        if accr_type in revenue_types:
            groups[key]['revenue'] += float(row.get('–ó–∞ –ø—Ä–æ–¥–∞–∂—É –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –¥–æ –≤—ã—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–π –∏ —É—Å–ª—É–≥', 0) or 0)
        if accr_type in ["–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é", "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é ‚Äî –æ—Ç–º–µ–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è"]:
            groups[key]['com_sale'] += float(row.get('–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –ø—Ä–æ–¥–∞–∂—É', 0) or 0)
        if accr_type == "–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞, –æ—Ç–º–µ–Ω—ã, –Ω–µ–≤—ã–∫—É–ø–∞ –æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è":
            groups[key]['com_return'] += float(row.get('–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –ø—Ä–æ–¥–∞–∂—É', 0) or 0)

        # –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã –∏ —É—Å–ª—É–≥–∏
        groups[key]['–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞'] += float(row.get('–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞', 0) or 0)
        groups[key]['–ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è'] += float(row.get('–ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è (—Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–æ–ª–µ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞ –≤ —Å—É–º–º–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è)', 0) or 0)
        groups[key]['–û–±—Ä–∞—Ç–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å'] += float(row.get('–û–±—Ä–∞—Ç–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å', 0) or 0)
        if accr_type == "–û–ø–ª–∞—Ç–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞":
            groups[key]['–û–ø–ª–∞—Ç–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)

        # –î–ª—è FBO, –ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤, –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è, –ü—Ä–æ—á–∏—Ö —É—Å–ª—É–≥ ‚Äî –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
        if accr_type in fbo_types:
            groups[key]['–£—Å–ª—É–≥–∏ FBO'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)
        if accr_type in partner_types:
            groups[key]['–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ —É—Å–ª—É–≥–∏'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)
        if accr_type in promo_types:
            groups[key]['–ó–∞—Ç—Ä–∞—Ç—ã–ù–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)
        if accr_type in other_services_types:
            groups[key]['–î—Ä—É–≥–∏–µ–£—Å–ª—É–≥–∏'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)
        if accr_type in compensation_types:
            groups[key]['–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)

        # –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (—Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
        groups[key]['–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ/—É—Ç–∏–ª–∏–∑–∞—Ü–∏—é –≤–æ–∑–≤—Ä–∞—Ç–æ–≤'] += float(row.get('–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ/—É—Ç–∏–ª–∏–∑–∞—Ü–∏—é –≤–æ–∑–≤—Ä–∞—Ç–æ–≤', 0) or 0)
        groups[key]['–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞'] += float(row.get('–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞', 0) or 0)
        groups[key]['–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è'] += float(row.get('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Drop-off/Pick-up) (—Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –ø–æ —Ç–æ–≤–∞—Ä–∞–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–∏)', 0) or 0)
        groups[key]['–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å'] += float(row.get('–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å', 0) or 0)
        groups[key]['–õ–æ–≥–∏—Å—Ç–∏–∫–∞'] += float(row.get('–õ–æ–≥–∏—Å—Ç–∏–∫–∞', 0) or 0)
        groups[key]['–û–±—Ä–∞—Ç–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞'] += float(row.get('–û–±—Ä–∞—Ç–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞', 0) or 0)
        # –°—Ç–∞—Ä—ã–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–Ω—É–∂–Ω—ã –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ–π)
        groups[key]['–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞: –ø–æ–∑–¥–Ω—è—è –æ—Ç–≥—Ä—É–∑–∫–∞'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0) if accr_type == '–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞: –ø–æ–∑–¥–Ω—è—è –æ—Ç–≥—Ä—É–∑–∫–∞' else 0
        groups[key]['–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞: –ø–æ–∑–¥–Ω—è—è –æ—Ç–≥—Ä—É–∑–∫–∞ - –æ—Ç–º–µ–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0) if accr_type == '–£—Å–ª—É–≥–∞ –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞: –ø–æ–∑–¥–Ω—è—è –æ—Ç–≥—Ä—É–∑–∫–∞ - –æ—Ç–º–µ–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è' else 0
        groups[key]['–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞: –í—ã –Ω–µ –∑–∞–±—Ä–∞–ª–∏ –≤ —Å—Ä–æ–∫'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0) if accr_type == '–£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞: –í—ã –Ω–µ –∑–∞–±—Ä–∞–ª–∏ –≤ —Å—Ä–æ–∫' else 0

        if accr_type == "–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞":
            groups[key]['–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)
        if accr_type == "–ë–∞–ª–ª—ã –∑–∞ –æ—Ç–∑—ã–≤—ã":
            groups[key]['–ë–∞–ª–ª—ã –∑–∞ –æ—Ç–∑—ã–≤—ã'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)
        if accr_type == "–í—ã–≤–æ–¥ –≤ —Ç–æ–ø":
            groups[key]['–í—ã–≤–æ–¥ –≤ —Ç–æ–ø'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)
        if accr_type == "–ü–æ–¥–ø–∏—Å–∫–∞ Premium":
            groups[key]['–ü–æ–¥–ø–∏—Å–∫–∞ Premium'] += float(row.get('–ò—Ç–æ–≥–æ', 0) or 0)

    result = []
    for key, vals in groups.items():
        sold_qty = vals.get('qty_sale', 0) - vals.get('qty_return', 0)
        revenue = vals.get('revenue', 0)
        commission = vals.get('com_sale', 0) + vals.get('com_return', 0)
        posled_milya = vals.get('–ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è', 0)
        obr_magistral = vals.get('–û–±—Ä–∞—Ç–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å', 0)
        oplata_ekv = vals.get('–û–ø–ª–∞—Ç–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞', 0)

        # --- –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ —Ç–≤–æ–∏–º –ø—Ä–∞–≤–∏–ª–∞–º ---
        uslugi_fbo = vals.get('–£—Å–ª—É–≥–∏ FBO', 0)
        uslugi_partnerov = posled_milya + obr_magistral - oplata_ekv + vals.get('–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ —É—Å–ª—É–≥–∏', 0)
        zatraty_na_prodvizhenie = vals.get('–ó–∞—Ç—Ä–∞—Ç—ã–ù–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ', 0)
        drugie_uslugi = vals.get('–î—Ä—É–≥–∏–µ–£—Å–ª—É–≥–∏', 0)

        # –ò—Ç–æ–≥–æ–≤–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ (—Å—Ç–∞—Ä–æ–µ)
        vals['–ò—Ç–æ–≥–õ–æ–≥–∏—Å—Ç–∏–∫–∞'] = vals.get('–õ–æ–≥–∏—Å—Ç–∏–∫–∞', 0) + vals.get('–û–±—Ä–∞—Ç–Ω–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞', 0)

        profit = (
            revenue
            + commission
            + vals.get('–ò—Ç–æ–≥–õ–æ–≥–∏—Å—Ç–∏–∫–∞', 0)
            + drugie_uslugi
            + uslugi_partnerov
            + uslugi_fbo
            + vals.get('–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏', 0)
        )

        row = list(key)
        row += [
            sold_qty,
            revenue,
            commission
        ]

        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –ø–æ HEADER
        for col in HEADER[8:-1]:  # -1 —á—Ç–æ–±—ã –ø—Ä–∏–±—ã–ª—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ü–µ
            if col == "–ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è":
                row.append(posled_milya)
            elif col == "–û–±—Ä–∞—Ç–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å":
                row.append(obr_magistral)
            elif col == "–û–ø–ª–∞—Ç–∞ —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞":
                row.append(oplata_ekv)
            elif col == "–£—Å–ª—É–≥–∏ FBO":
                row.append(uslugi_fbo)
            elif col == "–£—Å–ª—É–≥–∏–ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤":
                row.append(uslugi_partnerov)
            elif col == "–ó–∞—Ç—Ä–∞—Ç—ã–ù–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ":
                row.append(zatraty_na_prodvizhenie)
            elif col == "–î—Ä—É–≥–∏–µ–£—Å–ª—É–≥–∏":
                row.append(drugie_uslugi)
            else:
                row.append(vals.get(col, 0))
        row.append(profit)
        result.append(row)

    result_df = pd.DataFrame(result, columns=HEADER)
    logger.info(f'–ê–≥—Ä–µ–≥–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–æ–ª—É—á–µ–Ω–æ —Å—Ç—Ä–æ–∫: {len(result_df)}')
    return result_df


def main():
    logger = setup_logger('aggregator')
    orgs_dir = os.path.join(BASE_DIR, '–ù–∞—á–∏—Å–ª–µ–Ω–∏—è–£—Å–ª—É–≥–û–∑–æ–Ω')
    if not os.path.exists(orgs_dir):
        logger.error(f"–ù–µ—Ç –ø–∞–ø–∫–∏: {orgs_dir}")
        print(f"‚ùå –ù–µ—Ç –ø–∞–ø–∫–∏: {orgs_dir}")
        return

    # –ò—â–µ–º –≤—Å–µ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏ (–ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º)
    org_folders = [os.path.join(orgs_dir, name) for name in os.listdir(orgs_dir) if os.path.isdir(os.path.join(orgs_dir, name))]
    files = []
    for folder in org_folders:
        files += [os.path.join(folder, f) for f in os.listdir(folder) if f.endswith('.xlsx')]

    logger.info(f'–§–∞–π–ª–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ: {len(files)}')
    print(f'üîé –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(files)}')

    frames = []
    for f in files:
        org_name = os.path.basename(os.path.dirname(f))
        logger.info(f'‚Üí –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: {os.path.basename(f)} | –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: {org_name}')
        df = pd.read_excel(f)
        df['organization'] = org_name  # –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
        frames.append(df)

    if not frames:
        logger.error("‚ùå –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏!")
        print("‚ùå –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏!")
        return

    df_raw = pd.concat(frames, ignore_index=True)
    df_aggr = aggregate_data(df_raw)
    write_to_excel(df_aggr)
    logger.info('‚úì –ì–æ—Ç–æ–≤–æ!')
    print('‚úì –ì–æ—Ç–æ–≤–æ!')

if __name__ == "__main__":
    main()